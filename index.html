<html>
	<head>
		<script type="text/javascript" src="dcpu16.js"></script>
		<script type="text/dcpu-asm" id="example-1">
		        ; Try some basic stuff
                      set A, 0x30              ; 7c01 0030
                      SET [0x1000], 0x20       ; 7de1 1000 0020
                      SUB a, [0x1000]          ; 7803 1000
                      IfN A, 0x10              ; c00d 
                         SET Pc, crash         ; 7dc1 001a [*]
                      
        ; Do a loopy thing
                      SET I, 10                ; a861
                      SET A, 0x2000            ; 7c01 2000
        :loop
                 SET [0x2000+I], [A]      ; 2161 2000
                      SUB I, 1                 ; 8463
                      IFN I, 0                 ; 806d
                         SET PC, loop          ; 7dc1 000d [*]
        
        ; Call a subroutine
                      SET X, 0x4               ; 9031
                      JSR testsub              ; 7c10 0018 [*]
                      SET PC, crash            ; 7dc1 001a [*]
        
        :testsub      SHL X, 4                 ; 9037
                      SET PC, POP              ; 61c1
                        
        ; Hang forever. X should now be 0x40 if everything went right.
        :crash        SET PC, crash            ; 7dc1 001a [*]
        
        :data
        			dat 0x170, "Hello, World!", 0x65, 73, "w0,,0t!"
        
        ; [*]: Note that these can be one word shorter and one cycle faster by using the short form (0x00-0x1f) of literals,
        ;      but my assembler doesn't support short form labels yet.
		</script>
		<script type="text/dcpu-asm" id="example-screen">
:start
	set i, 0
	set j, 0
	set b, 0xf100

:nextchar
	set a, (data+i)
	ife a, 0
		set PC, end
	ifg a, 0xff
		set PC, setcolor
	bor a, b
	set (0x8000+j), a
	add i, 1
	add j, 1
	set PC, nextchar

:setcolor
	set b, a
	and b, 0xff
	shl b, 8
	ifg a, 0x1ff
		add b, 0x80
	add i, 1
	set PC, nextchar

:data
	dat 0x170, "Hello ", 0x2e1, "world", 0x170, ", how are you?", 0x0

:end
	set PC, start
		</script>
	</head>
<body>
<p>
	<a href="javascript:void(0);" onclick="load('example-1');">Ref example</a>
	<a href="javascript:void(0);" onclick="load('example-screen');">Screen buffer example</a>
</p>
<textarea id="src" rows="30" cols="140"></textarea>
<p>
	<button onclick="asm();">Assemble</button>
	Run <input type="text" id="steps" value="300" /><button onclick="step();">Steps</button>
	<button onclick="print();">Show screen buffer</button>
</p>

<div id="status" style="width: 200px; border: 1px solid black; float: left;"></div>
<div id="out" style="margin-left: 210px; width: 400px; border: 1px solid black;"></div>

<script type="text/javascript">
	var PC,
		load = function (what) {
			document.getElementById('src').value = document.getElementById(what).innerHTML;
		},
		asm = function () {
			var src = document.getElementById('src').value,
				out = document.getElementById('out'),
				bc = DCPU16.asm(src),
				t;
				
			PC = new DCPU16.PC(bc);
			out.innerHTML = '';
			for (i = 0; i < bc.length; i++) {
				t = bc[i].toString(16);
				out.innerHTML += (t.length == 1 ? '0' : '') + t + (i % 2 == 1 ? ' ' : '');
			}
		},
		step = function () {
			var i, steps = parseInt(document.getElementById('steps').value);
			
			for (i = 0; i < steps; i++) {
				PC.step();
			}
			printStatus();
		},
		printValue = function (v) {
			var r = v.toString(16);
				
			return r;
		},
		printStatus = function () {
			var status = document.getElementById('status');
			
			status.innerHTML = 'A = ' + printValue(PC.ram.A) + '<br />';
			status.innerHTML += 'B = ' + printValue(PC.ram.B) + '<br />';
			status.innerHTML += 'C = ' + printValue(PC.ram.C) + '<br />';
			status.innerHTML += 'X = ' + printValue(PC.ram.X) + '<br />';
			status.innerHTML += 'Y = ' + printValue(PC.ram.Y) + '<br />';
			status.innerHTML += 'Z = ' + printValue(PC.ram.Z) + '<br />';
			status.innerHTML += 'I = ' + printValue(PC.ram.I) + '<br />';
			status.innerHTML += 'J = ' + printValue(PC.ram.J) + '<br />';

			status.innerHTML += 'PC = ' + printValue(PC.ram.PC) + '<br />';
			status.innerHTML += 'SP = ' + printValue(PC.ram.SP) + '<br />';
			status.innerHTML += 'O = ' + printValue(PC.ram.O) + '<br />';
		},
		print = function () {
			var out = document.getElementById('out');
			out.innerHTML = PC.screen2html();
		};
		
	load('example-screen');
</script>
</body>
</html>
